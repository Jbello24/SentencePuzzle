let levels = {};
let currentLevel = 1;
let correctOrder = [];
let completedLevels = [];

const puzzleGrid = document.getElementById('puzzle-grid');
const optionsGrid = document.getElementById('options-grid');

document.getElementById('start-game').addEventListener('click', startGame);
document.getElementById('num-levels').addEventListener('change', updateLevelInputs);

function updateLevelInputs() {
    const numLevels = document.getElementById('num-levels').value;
    const levelInputsContainer = document.getElementById('level-inputs');
    levelInputsContainer.innerHTML = '';

    for (let i = 1; i <= numLevels; i++) {
        const div = document.createElement('div');
        div.className = 'level-input';
        div.innerHTML = `
            <label for="level-${i}">Nivel ${i}:</label>
            <input type="text" id="level-${i}" name="level-${i}" required>
        `;
        levelInputsContainer.appendChild(div);
    }
}

function startGame() {
    const form = document.getElementById('levels-form');
    const numLevels = document.getElementById('num-levels').value;

    for (let i = 1; i <= numLevels; i++) {
        const levelInput = form[`level-${i}`].value.split(' ');
        levels[i] = levelInput;
    }

    const urlParams = new URLSearchParams();
    for (const [key, value] of Object.entries(levels)) {
        urlParams.append(`level${key}`, value.join(' '));
    }
    const shareableLink = `${window.location.href.split('?')[0]}?${urlParams.toString()}`;

    document.getElementById('generated-link').textContent = shareableLink;
    document.getElementById('share-link').classList.remove('hidden');

    setLevel(1);
    document.getElementById('input-form').classList.add('hidden');
    document.getElementById('puzzle').classList.remove('hidden');
    document.getElementById('level-buttons').classList.remove('hidden');
}

function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

function createPuzzle() {
    puzzleGrid.innerHTML = '';
    optionsGrid.innerHTML = '';
    correctOrder = levels[currentLevel];

    for (let i = 0; i < correctOrder.length; i++) {
        const placeholder = document.createElement('div');
        placeholder.classList.add('placeholder');
        placeholder.dataset.index = i;
        puzzleGrid.appendChild(placeholder);
        placeholder.addEventListener('dragover', dragOver);
        placeholder.addEventListener('drop', drop);
    }

    const shuffledPhrases = shuffle([...levels[currentLevel]]);
    shuffledPhrases.forEach((phrase, index) => {
        const piece = document.createElement('div');
        piece.classList.add('option-piece');
        piece.textContent = phrase;
        piece.draggable = true;
        piece.dataset.index = index;

        piece.addEventListener('dragstart', dragStart);
        piece.addEventListener('dragend', dragEnd);

        optionsGrid.appendChild(piece);
    });
}

function dragStart(e) {
    e.dataTransfer.setData('text/plain', e.target.dataset.index);
    setTimeout(() => {
        e.target.classList.add('dragging');
    }, 0);
}

function dragEnd(e) {
    e.target.classList.remove('dragging');
}

function dragOver(e) {
    e.preventDefault();
}

function drop(e) {
    e.preventDefault();
    const draggedIndex = e.dataTransfer.getData('text/plain');
    const draggedElement = document.querySelector(`.option-piece[data-index='${draggedIndex}']`);
    const targetElement = e.target;

    if (targetElement.classList.contains('placeholder')) {
        targetElement.textContent = draggedElement.textContent;
        targetElement.classList.remove('placeholder');
        targetElement.classList.add('puzzle-piece');
        draggedElement.remove();
    }
}

function checkPuzzle() {
    const pieces = Array.from(puzzleGrid.querySelectorAll('.puzzle-piece'));
    const currentOrder = pieces.map(piece => piece.textContent);
    const isCorrect = JSON.stringify(currentOrder) === JSON.stringify(correctOrder);
    if (isCorrect) {
        alert('¡Correcto!');
        document.getElementById(`level-${currentLevel}`).classList.add('locked');
        document.getElementById(`level-${currentLevel}`).disabled = true;
        completedLevels.push(currentLevel);
    } else {
        alert('Inténtalo de nuevo');
    }
}

function setLevel(level) {
    if (completedLevels.includes(level)) return;
    currentLevel = level;
    createPuzzle();
}

document.getElementById('check-puzzle').addEventListener('click', checkPuzzle);

function init() {
    const urlParams = new URLSearchParams(window.location.search);
    const loadedLevels = {};
    urlParams.forEach((value, key) => {
        if (key.startsWith('level')) {
            const levelNum = key.replace('level', '');
            loadedLevels[levelNum] = value.split(' ');
        }
    });

    if (Object.keys(loadedLevels).length > 0) {
        levels = loadedLevels;
        document.getElementById('input-form').classList.add('hidden');
        document.getElementById('puzzle').classList.remove('hidden');
        document.getElementById('level-buttons').classList.remove('hidden');
        setLevel(1);
    } else {
        updateLevelInputs();
    }
}

window.onload = init;
